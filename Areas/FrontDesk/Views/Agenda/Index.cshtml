@model IEnumerable<CabinetMedicalWeb.Models.RendezVous>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Agenda Hebdomadaire";

    var startOfWeek = (DateTime)ViewData["StartOfWeek"];
    var previousWeek = (DateTime)ViewData["PreviousWeek"];
    var nextWeek = (DateTime)ViewData["NextWeek"];

    var rendezVousList = Model?.ToList() ?? new List<CabinetMedicalWeb.Models.RendezVous>();
    var daysOfWeek = new[] { "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi" };

    var primaryColor = "#7AA3D1";
    var bgPage = "#E9EFF7";
    var textDark = "#0f172a";

    // time range (for quick scroll)
    var firstHour = 8;
    var lastHour = 18;
    var now = DateTime.Now;
    var isCurrentWeek = now.Date >= startOfWeek.Date && now.Date <= startOfWeek.AddDays(4).Date;
    var nowHour = Math.Clamp(now.Hour, firstHour, lastHour);
}

<style>
    :root{
        --primary: @primaryColor;
        --primary2: #91B3D9;
        --ink: @textDark;
        --muted: #64748b;
        --surface: rgba(255,255,255,.92);
        --border: rgba(226,232,240,.9);
        --bg: @bgPage;
        --shadow: 0 18px 42px rgba(15,23,42,.08);
        --shadow2: 0 10px 25px -5px rgba(122,163,209,.35);
        --radius-lg: 20px;
        --radius-md: 14px;
    }

    html{ scroll-behavior:smooth; }
    body{
        background:
            radial-gradient(circle at 12% 10%, rgba(122,163,209,.18), transparent 44%),
            radial-gradient(circle at 86% 0%, rgba(167,203,237,.22), transparent 46%),
            var(--bg);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    @@keyframes fadeInUp{
        from{opacity:0;transform:translateY(16px)}
        to{opacity:1;transform:translateY(0)}
    }
    @@keyframes fadeInDown{
        from{opacity:0;transform:translateY(-14px)}
        to{opacity:1;transform:translateY(0)}
    }

    /* ===== Header ===== */
    .agenda-header{
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
        border-radius: var(--radius-lg);
        padding: 1.8rem 2.1rem;
        color: #fff;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow2);
        display:flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 1rem;
        position: relative;
        overflow:hidden;
        animation: fadeInDown .6s cubic-bezier(.16,1,.3,1) both;
    }
    .agenda-header::after{
        content:"";
        position:absolute;
        right:-120px; top:-140px;
        width:320px;height:320px;
        background: radial-gradient(circle, rgba(255,255,255,.18), transparent 62%);
        border-radius:50%;
        pointer-events:none;
    }

    .header-content h1{
        margin:0;
        font-weight: 900;
        letter-spacing: -0.03em;
        font-size: 2.05rem;
        line-height: 1.05;
    }
    .header-content p{
        margin:.45rem 0 0;
        opacity:.9;
        font-weight: 600;
        display:flex;
        align-items:center;
        gap:.55rem;
        flex-wrap: wrap;
    }

    .header-actions{
        display:flex;
        gap:.6rem;
        align-items:center;
        flex-wrap: wrap;
        position: relative;
        z-index: 2;
    }

    .btn-nav{
        border: 1px solid rgba(255,255,255,.35);
        background: rgba(255,255,255,.18);
        color:#fff;
        padding: .55rem .95rem;
        border-radius: 999px;
        font-weight: 800;
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        gap:.45rem;
        transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
        backdrop-filter: blur(6px);
    }
    .btn-nav:hover{
        color:#fff;
        transform: translateY(-1px);
        background: rgba(255,255,255,.26);
        box-shadow: 0 14px 26px -18px rgba(15,23,42,.55);
    }

    .btn-create{
        border: 0;
        background: rgba(255,255,255,.95);
        color: #0f172a;
        padding: .75rem 1.05rem;
        border-radius: 14px;
        font-weight: 900;
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        gap:.55rem;
        box-shadow: 0 18px 34px -28px rgba(15,23,42,.6);
        transition: transform .15s ease, box-shadow .15s ease;
        position: relative;
        z-index: 2;
        white-space: nowrap;
    }
    .btn-create:hover{
        transform: translateY(-2px);
        box-shadow: 0 26px 44px -32px rgba(15,23,42,.7);
        color:#0f172a;
    }

    /* ===== Toolbar under header ===== */
    .agenda-toolbar{
        display:flex;
        justify-content: space-between;
        align-items:center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        animation: fadeInUp .6s cubic-bezier(.16,1,.3,1) both;
        animation-delay: .05s;
    }

    .legend{
        display:flex;
        gap: .9rem;
        align-items:center;
        flex-wrap: wrap;
        color: var(--muted);
        font-weight: 700;
        font-size: .9rem;
    }
    .legend-dot{ width:10px;height:10px;border-radius:999px;display:inline-block; }
    .dot-appt{ background: linear-gradient(135deg, var(--primary), #a7cbed); }
    .dot-now{ background:#f59e0b; }

    .btn-jump{
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--ink);
        padding: .6rem .9rem;
        border-radius: 12px;
        font-weight: 900;
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        gap:.45rem;
        box-shadow: 0 12px 28px -22px rgba(15,23,42,.45);
        transition: transform .15s ease, border-color .15s ease;
        white-space: nowrap;
    }
    .btn-jump:hover{
        transform: translateY(-1px);
        border-color: rgba(122,163,209,.65);
        color: var(--ink);
    }

    /* ===== Calendar container ===== */
    .calendar-container{
        background: rgba(255,255,255,.75);
        border: 1px solid rgba(226,232,240,.75);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        overflow:hidden;
        animation: fadeInUp .65s cubic-bezier(.16,1,.3,1) both;
        animation-delay: .1s;
        backdrop-filter: blur(10px);
    }

    .table-wrap{
        max-height: calc(100vh - 270px);
        overflow:auto;
        scroll-behavior:smooth;
        -webkit-overflow-scrolling: touch;
    }

    /* Sticky header row */
    .agenda-table{
        width:100%;
        border-collapse: separate;
        border-spacing: 0;
        background: transparent;
        table-layout: fixed;
        min-width: 980px;
    }

    .agenda-table thead th{
        position: sticky;
        top: 0;
        z-index: 5;
        background: rgba(248,250,252,.96);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border);
        padding: .85rem .75rem;
        font-size: .78rem;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: var(--muted);
        font-weight: 900;
    }

    .time-col{ width: 90px; }

    .day-head{
        display:flex;
        flex-direction: column;
        align-items:center;
        gap:.15rem;
        line-height: 1.1;
    }
    .day-num{
        font-size: 1.2rem;
        font-weight: 950;
        color: var(--ink);
        letter-spacing: -0.02em;
    }
    .day-name{
        opacity:.75;
        font-weight: 900;
    }

    .today-col{
        background: rgba(122,163,209,.10) !important;
        box-shadow: inset 0 -2px 0 rgba(122,163,209,.55);
    }

    .agenda-table tbody td{
        border-bottom: 1px solid rgba(226,232,240,.65);
        border-right: 1px solid rgba(226,232,240,.55);
        padding: .55rem .55rem;
        vertical-align: top;
        background: rgba(255,255,255,.66);
    }
    .agenda-table tbody td:last-child{ border-right: none; }

    .agenda-table tbody tr:hover td{
        background: rgba(248,250,252,.9);
    }

    .time-slot{
        position: sticky;
        left: 0;
        z-index: 4;
        background: rgba(248,250,252,.98);
        backdrop-filter: blur(8px);
        border-right: 1px solid rgba(226,232,240,.9);
        color: var(--muted);
        font-weight: 950;
        font-size: .9rem;
        text-align: center;
    }

    /* Highlight "now" row for current week */
    .row-now td{
        background: rgba(245,158,11,.06);
    }
    .row-now .time-slot{
        color:#b45309;
        box-shadow: inset 0 0 0 2px rgba(245,158,11,.22);
    }

    /* Appointment card */
    .appt-card{
        background: rgba(255,255,255,.95);
        border: 1px solid rgba(226,232,240,.95);
        border-radius: 14px;
        padding: .65rem .7rem;
        margin-bottom: .5rem;
        box-shadow: 0 10px 18px -18px rgba(15,23,42,.45);
        transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
        cursor: pointer;
        position: relative;
        overflow:hidden;
    }
    .appt-card::before{
        content:"";
        position:absolute;
        left:0; top:0; bottom:0;
        width: 4px;
        background: linear-gradient(180deg, var(--primary), #a7cbed);
        opacity:.95;
    }
    .appt-card:hover{
        transform: translateY(-2px);
        border-color: rgba(122,163,209,.55);
        box-shadow: 0 18px 30px -22px rgba(15,23,42,.55);
        z-index: 10;
    }

    .appt-time{
        font-size: .78rem;
        font-weight: 950;
        color: var(--primary);
        margin-bottom: 2px;
        display:block;
    }
    .appt-name{
        font-weight: 950;
        font-size: .92rem;
        color: var(--ink);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display:block;
    }
    .appt-doc{
        font-size: .83rem;
        color: #64748b;
        display:block;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .appt-motif{
        margin-top: .35rem;
        font-size: .82rem;
        color: #475569;
        opacity:.9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cell-empty{
        opacity:.55;
        text-align:center;
        color:#94a3b8;
        font-weight: 900;
        padding: .25rem 0;
        user-select:none;
    }

    .empty-state{
        text-align:center;
        padding: 3.2rem 1.5rem;
        color: #94a3b8;
        background: rgba(255,255,255,.75);
        border-top: 1px solid rgba(226,232,240,.85);
    }

    /* Tiny helper */
    .kbd{
        display:inline-flex;
        align-items:center;
        gap:.35rem;
        padding:.25rem .55rem;
        border-radius: 10px;
        border: 1px solid rgba(226,232,240,.95);
        background: rgba(255,255,255,.9);
        color: #334155;
        font-weight: 900;
        font-size: .78rem;
    }

    @@media (max-width: 992px){
        .agenda-header{ padding: 1.4rem 1.35rem; }
        .header-content h1{ font-size: 1.75rem; }
        .btn-create{ width: 100%; justify-content:center; }
        .agenda-toolbar{ gap: .65rem; }
        .table-wrap{ max-height: calc(100vh - 300px); }
    }

    @@media (prefers-reduced-motion: reduce){
        html{ scroll-behavior:auto; }
        *{ animation:none !important; transition:none !important; }
    }
</style>

<div class="container-fluid py-4" style="max-width: 1600px;">

    <!-- 1) Header -->
    <div class="agenda-header">
        <div class="header-content">
            <h1>Agenda Hebdomadaire</h1>
            <p>
                <i class="far fa-calendar-alt"></i>
                Semaine du @startOfWeek.ToString("dd MMMM") au @startOfWeek.AddDays(4).ToString("dd MMMM yyyy")
            </p>

            <div class="header-actions mt-3">
                <a asp-area="FrontDesk" asp-controller="Agenda" asp-action="Index"
                   asp-route-startDate="@previousWeek.ToString("yyyy-MM-dd")"
                   class="btn-nav">
                    <i class="fas fa-arrow-left"></i> Semaine précédente
                </a>

                <a asp-area="FrontDesk" asp-controller="Agenda" asp-action="Index"
                   asp-route-startDate="@DateTime.Today.ToString("yyyy-MM-dd")"
                   class="btn-nav">
                    <i class="fas fa-calendar-day"></i> Cette semaine
                </a>

                <a asp-area="FrontDesk" asp-controller="Agenda" asp-action="Index"
                   asp-route-startDate="@nextWeek.ToString("yyyy-MM-dd")"
                   class="btn-nav">
                    Semaine suivante <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>

        <a asp-area="FrontDesk" asp-controller="RendezVous" asp-action="Create" class="btn-create">
            <i class="fas fa-plus-circle"></i> Nouveau Rendez-vous
        </a>
    </div>

    <!-- 2) Toolbar -->
    <div class="agenda-toolbar">
        <div class="legend">
            <span><span class="legend-dot dot-appt"></span> Rendez-vous</span>
            @if (isCurrentWeek)
            {
                <span><span class="legend-dot dot-now"></span> Heure actuelle</span>
                <span class="kbd"><i class="fas fa-mouse-pointer"></i> Astuce : cliquez sur un RDV</span>
            }
        </div>

        @if (isCurrentWeek)
        {
            <a class="btn-jump" href="#hour-@nowHour">
                <i class="fas fa-location-arrow"></i> Aller à maintenant
            </a>
        }
    </div>

    <!-- 3) Calendar -->
    <div class="calendar-container">
        <div class="table-wrap" id="agendaScroll">
            <table class="agenda-table">
                <thead>
                    <tr>
                        <th class="time-col"></th>
                        @for (int i = 0; i < 5; i++)
                        {
                            var date = startOfWeek.AddDays(i);
                            var isToday = date.Date == DateTime.Today;

                            <th class="@(isToday ? "today-col" : "")">
                                <div class="day-head">
                                    <span class="day-name">@daysOfWeek[i]</span>
                                    <span class="day-num">@date.Day</span>
                                </div>
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (int hour = firstHour; hour <= lastHour; hour++)
                    {
                        var isNowRow = isCurrentWeek && hour == nowHour;

                        <tr class="@(isNowRow ? "row-now" : "")" id="hour-@hour">
                            <td class="time-slot">@hour:00</td>

                            @for (int day = 0; day < 5; day++)
                            {
                                var currentDate = startOfWeek.AddDays(day);

                                var rdvsForCell = rendezVousList
                                    .Where(r => r.DateHeure.Date == currentDate.Date && r.DateHeure.Hour == hour)
                                    .OrderBy(r => r.DateHeure)
                                    .ToList();

                                <td>
                                    @if (rdvsForCell.Any())
                                    {
                                        foreach (var rdv in rdvsForCell)
                                        {
                                            // Optional: link to details if you have it
                                            var detailsUrl = Url.Action("Details", "RendezVous", new { area = "FrontDesk", id = rdv.Id });

                                            <a class="appt-card d-block text-decoration-none"
                                               href="@detailsUrl"
                                               title="Motif : @rdv.Motif">
                                                <span class="appt-time"><i class="far fa-clock me-1"></i>@rdv.DateHeure.ToString("HH:mm")</span>
                                                <span class="appt-name">@rdv.Patient.Nom @rdv.Patient.Prenom</span>
                                                <span class="appt-doc"><i class="fas fa-user-md me-1"></i>Dr. @rdv.Doctor.Nom</span>
                                                @if (!string.IsNullOrWhiteSpace(rdv.Motif))
                                                {
                                                    <span class="appt-motif"><i class="fas fa-tag me-1"></i>@rdv.Motif</span>
                                                }
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <div class="cell-empty">—</div>
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!rendezVousList.Any())
        {
            <div class="empty-state">
                <i class="far fa-calendar-check fa-3x mb-3"></i>
                <h5 class="fw-bold text-dark mb-2">Aucun rendez-vous cette semaine</h5>
                <p class="mb-0">Utilisez le bouton “Nouveau Rendez-vous” pour planifier une consultation.</p>
            </div>
        }
    </div>
</div>

@section Scripts{
<script>
    // Smoothly scroll the table container to "now" row on load (current week only)
    (function () {
        const isCurrentWeek = @isCurrentWeek.ToString().ToLower();
        if (!isCurrentWeek) return;

        const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (reduceMotion) return;

        const container = document.getElementById("agendaScroll");
        const target = document.getElementById("hour-@nowHour");
        if (!container || !target) return;

        // slight delay so layout is stable
        window.requestAnimationFrame(() => {
            const y = target.offsetTop - 110; // keep header visible
            container.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
        });
    })();
</script>
}
