@model IEnumerable<CabinetMedicalWeb.Models.Patient>

@{
    ViewData["Title"] = "Gestion des Patients";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var primaryColor = "#7AA3D1";
    var bgPage = "#E9EFF7";
    var textDark = "#1F2937";
    var textMuted = "#6B7280";
    var surfaceColor = "#FFFFFF";
    var borderColor = "#D4DEEC";
}

<style>
    :root{
        --primary:@primaryColor;
        --bg:@bgPage;
        --dark:@textDark;
        --muted:@textMuted;
        --surface:@surfaceColor;
        --border:@borderColor;
    }

    html { scroll-behavior: smooth; }

    body{
        background:
            radial-gradient(circle at 12% 12%, rgba(122,163,209,.18), transparent 35%),
            radial-gradient(circle at 90% 0%, rgba(145,179,217,.16), transparent 35%),
            var(--bg);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* ===== PERF: avoid “blocking” =====
       - keep blur minimal
       - animate only transform/opacity
       - avoid huge shadows changing on hover
       - table area uses its own scrolling with sticky header
    */

    @@keyframes fadeInUp {
        from { opacity: 0; transform: translateY(12px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    .patients-shell{
        max-width: 1500px;
        margin: 1.25rem auto 3rem;
        padding: 0 1rem;

        opacity: 1;
        animation: fadeInUp .55s cubic-bezier(.16,1,.3,1) both;

        content-visibility: auto;
        contain-intrinsic-size: 1px 900px;
    }

    @@media (prefers-reduced-motion: reduce){
        html { scroll-behavior: auto; }
        .patients-shell{ animation: none !important; }
        *{ transition:none !important; }
    }

    /* Container (lighter blur to reduce jank) */
    .page-container{
        padding: 1.25rem;
        background: rgba(255,255,255,0.90);
        border-radius: 24px;
        border: 1px solid rgba(212,222,236,.95);
        box-shadow: 0 18px 42px rgba(31,41,55,0.06);
        /* keep blur tiny; heavy blur causes lag on some PCs */
        backdrop-filter: blur(6px);
    }

    /* Header */
    .header-section{
        display:flex;
        justify-content:space-between;
        align-items:flex-end;
        gap: 1rem;
        flex-wrap:wrap;
        padding: .25rem .25rem 1.25rem;
    }

    .title-wrap h1{
        font-size: 1.95rem;
        font-weight: 900;
        color: var(--dark);
        margin: 0;
        letter-spacing: -0.02em;
        display:flex;
        align-items:center;
        gap:.75rem;
    }
    .title-wrap h1 i{ color: var(--primary); }

    .title-wrap p{
        margin:.35rem 0 0 0;
        color: var(--muted);
        font-size: 1rem;
    }

    /* Toolbar */
    .toolbar{
        display:flex;
        gap:.75rem;
        align-items:center;
        flex-wrap:wrap;
        justify-content:flex-end;
        flex: 1 1 auto;
    }

    .search-wrapper{
        position: relative;
        min-width: 260px;
        flex: 1 1 340px;
        max-width: 520px;
    }

    .search-wrapper i{
        position:absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(107,114,128,.9);
        pointer-events:none;
    }

    .search-input{
        width: 100%;
        padding: .92rem 1rem .92rem 2.75rem;
        border-radius: 16px;
        border: 1px solid rgba(212,222,236,.95);
        background: rgba(243,244,246,.92);
        font-size: .95rem;
        outline: none;
        transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }

    .search-input:focus{
        background: #fff;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(122,163,209,.18);
    }

    .btn-primary-custom{
        background: linear-gradient(135deg, var(--primary) 0%, #6C8CFF 100%);
        color:#fff;
        padding: .92rem 1.25rem;
        border-radius: 16px;
        font-weight: 800;
        display:inline-flex;
        align-items:center;
        gap:.55rem;
        text-decoration:none;
        border: none;
        box-shadow: 0 10px 22px rgba(122,163,209,.28);
        transition: transform .18s ease, filter .18s ease, box-shadow .18s ease;
        white-space: nowrap;
    }

    .btn-primary-custom:hover{
        transform: translateY(-2px);
        filter: brightness(1.02);
        box-shadow: 0 14px 26px rgba(122,163,209,.32);
        color:#fff;
    }

    /* Optional quick stats (light + fast) */
    .chips-row{
        display:flex;
        flex-wrap:wrap;
        gap:.5rem;
        margin: 0 0 1rem .25rem;
    }
    .chip{
        display:inline-flex;
        align-items:center;
        gap:.45rem;
        padding: .45rem .8rem;
        border-radius: 999px;
        background: rgba(238,244,251,.95);
        border: 1px solid rgba(212,222,236,.95);
        color: rgba(31,41,55,.78);
        font-size: .88rem;
        font-weight: 800;
        white-space: nowrap;
    }
    .chip i{ color: var(--primary); }

    /* Table container */
    .table-container{
        background: var(--surface);
        border-radius: 20px;
        overflow:hidden;
        border: 1px solid rgba(212,222,236,.95);
        box-shadow: 0 10px 18px rgba(31,41,55,0.04);
    }

    /* The scroll area is inside (smoother than full page on huge tables) */
    .table-scroll{
        max-height: 70vh;
        overflow: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        scrollbar-gutter: stable;
    }

    /* Nice scrollbar (optional) */
    .table-scroll::-webkit-scrollbar{ height: 10px; width: 10px; }
    .table-scroll::-webkit-scrollbar-thumb{ background: rgba(122,163,209,.35); border-radius: 999px; }
    .table-scroll::-webkit-scrollbar-track{ background: rgba(241,245,249,.8); }

    .custom-table{
        width:100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .custom-table thead th{
        background: linear-gradient(180deg, #F8FAFC 0%, #F7FAFF 100%);
        padding: 1.05rem 1.25rem;
        text-align:left;
        font-size: .75rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: var(--muted);
        border-bottom: 1px solid rgba(212,222,236,.95);

        position: sticky;
        top: 0;
        z-index: 2;
    }

    .custom-table tbody tr{
        transition: background-color .12s ease;
        will-change: background-color;
    }

    .custom-table tbody tr:hover{
        background: #F8FAFC;
    }

    .custom-table td{
        padding: 1.05rem 1.25rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(241,245,249,.95);
        color: var(--dark);
        font-size: .95rem;
    }

    .custom-table tbody tr:last-child td{ border-bottom:none; }

    /* Patient cell */
    .patient-info{
        display:flex;
        align-items:center;
        gap: .9rem;
        min-width: 260px;
    }

    .avatar-circle{
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(135deg, #A7CBED, #7AA3D1);
        color:#fff;
        display:grid;
        place-items:center;
        font-weight: 900;
        font-size: 1.05rem;
        box-shadow: 0 10px 18px rgba(122,163,209,.22);
        flex: 0 0 auto;
        transform: translateZ(0);
    }

    .patient-name{
        font-weight: 900;
        color: var(--dark);
        display:block;
        line-height: 1.1;
        max-width: 320px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .patient-email{
        font-size: .85rem;
        color: var(--muted);
        display:block;
        margin-top: .15rem;
    }

    /* Contact lines */
    .contact-line{
        display:flex;
        align-items:center;
        gap:.5rem;
        color: var(--muted);
        font-size:.92rem;
        margin-bottom:.2rem;
        white-space: nowrap;
    }
    .contact-line i{ width:16px; color: rgba(107,114,128,.85); }

    /* DOB chip */
    .date-chip{
        display:inline-flex;
        align-items:center;
        gap:.5rem;
        background: #F1F5F9;
        padding: .4rem .75rem;
        border-radius: 10px;
        font-weight: 700;
        color: #4B5563;
        font-size: .9rem;
        white-space: nowrap;
    }

    /* Actions */
    .action-group{
        display:flex;
        gap:.45rem;
        justify-content:flex-end;
        white-space: nowrap;
    }

    .btn-icon{
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display:grid;
        place-items:center;
        color: var(--muted);
        background: rgba(243,244,246,.78);
        border: 1px solid rgba(212,222,236,.75);
        text-decoration:none;
        transition: transform .14s ease, background .14s ease, color .14s ease, border-color .14s ease;
        transform: translateZ(0);
    }

    .btn-icon:hover{
        transform: translateY(-1px);
        background: #fff;
        color: var(--primary);
        border-color: rgba(122,163,209,.55);
        box-shadow: 0 10px 16px rgba(31,41,55,.06);
    }

    .btn-icon.delete:hover{
        color:#EF4444;
        border-color:#FECACA;
        background:#FEF2F2;
        box-shadow: 0 10px 16px rgba(239,68,68,.12);
    }

    /* Empty state */
    .empty-state{
        text-align:center;
        padding: 4.5rem 1.5rem;
        color: var(--muted);
    }

    .empty-state i{
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: .55;
        color: var(--primary);
    }
    .empty-state .btn-link{ font-weight: 800; }

    /* Small responsive tweaks */
    @@media (max-width: 576px){
        .page-container{ padding: 1rem; }
        .patient-info{ min-width: 200px; }
        .patient-name{ max-width: 200px; }
    }
</style>

<div class="patients-shell">
    <div class="page-container">

        <!-- Header -->
        <div class="header-section">
            <div class="title-wrap">
                <h1><i class="fas fa-users"></i> Gestion des Patients</h1>
                <p>Consultez et gérez la base de données patients.</p>
            </div>

            <div class="toolbar">
                <form method="get" class="search-wrapper" role="search" aria-label="Recherche patients">
                    <i class="fas fa-search"></i>
                    <input type="text"
                           name="searchString"
                           value="@(ViewData["CurrentFilter"] ?? "")"
                           class="search-input"
                           placeholder="Rechercher par nom, prénom, téléphone..."
                           autocomplete="off" />
                </form>

                <a asp-area="FrontDesk" asp-controller="Patients" asp-action="Create" class="btn-primary-custom">
                    <i class="fas fa-user-plus"></i> Nouveau
                </a>
            </div>
        </div>

        <!-- Quick chips -->
        <div class="chips-row">
            <span class="chip"><i class="fas fa-database"></i> Total: @(Model?.Count() ?? 0)</span>
            <span class="chip"><i class="fas fa-bolt"></i> Vue optimisée</span>
        </div>

        <!-- Table Content -->
        <div class="table-container">
            @if (Model != null && Model.Any())
            {
                <div class="table-scroll" id="patientsTableScroll">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Coordonnées</th>
                                <th>Date de Naissance</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                var nom = item?.Nom ?? "";
                                var prenom = item?.Prenom ?? "";
                                var initial =
                                    (!string.IsNullOrEmpty(nom) ? nom[0].ToString() : "•") +
                                    (!string.IsNullOrEmpty(prenom) ? prenom[0].ToString() : "");

                                <tr>
                                    <td>
                                        <div class="patient-info">
                                            <div class="avatar-circle">@initial</div>
                                            <div class="overflow-hidden">
                                                <span class="patient-name">@nom.ToUpper() @prenom</span>
                                                <span class="patient-email">ID: #@item.Id</span>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <div class="d-flex flex-column">
                                            <div class="contact-line">
                                                <i class="fas fa-phone-alt"></i>
                                                <span>@(item?.Telephone ?? "—")</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(item?.Email))
                                            {
                                                <div class="contact-line">
                                                    <i class="fas fa-envelope"></i>
                                                    <span class="text-truncate" style="max-width: 320px;">@item.Email</span>
                                                </div>
                                            }
                                        </div>
                                    </td>

                                    <td>
                                        <span class="date-chip">
                                            <i class="far fa-calendar-alt"></i>
                                            @item.DateNaissance.ToString("dd MMM yyyy")
                                        </span>
                                    </td>

                                    <td class="text-end">
                                        <div class="action-group">
                                            <a asp-action="Details" asp-route-id="@item.Id" class="btn-icon" title="Voir les détails" aria-label="Voir">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn-icon" title="Modifier" aria-label="Modifier">
                                                <i class="fas fa-pen"></i>
                                            </a>
                                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn-icon delete" title="Supprimer" aria-label="Supprimer">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <h3 class="h5 fw-bold text-dark mt-3">Aucun patient trouvé</h3>
                    <p>Essayez une autre recherche ou ajoutez un nouveau patient pour commencer.</p>
                    @if (ViewData["CurrentFilter"] != null)
                    {
                        <a asp-action="Index" class="btn btn-link text-decoration-none mt-2">Effacer la recherche</a>
                    }
                </div>
            }
        </div>

    </div>
</div>

@section Scripts{
<script>
    // Smoothest scroll on heavy pages: keep scroll work inside the table container
    // and avoid layout thrash (no timers/intervals).
    document.addEventListener("DOMContentLoaded", () => {
        const scroller = document.getElementById("patientsTableScroll");
        if (!scroller) return;

        // Optional: smoother trackpad/wheel feel inside table when user scrolls the page
        // by capturing wheel only when the container can scroll.
        scroller.addEventListener("wheel", (e) => {
            const canScrollDown = scroller.scrollTop + scroller.clientHeight < scroller.scrollHeight;
            const canScrollUp = scroller.scrollTop > 0;
            if ((e.deltaY > 0 && canScrollDown) || (e.deltaY < 0 && canScrollUp)) {
                // Let the container handle it; prevent the body from "fighting" (jank)
                e.stopPropagation();
            }
        }, { passive: true });
    });
</script>
}
