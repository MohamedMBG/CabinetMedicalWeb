@using System.Globalization
@using System.Linq
@model CabinetMedicalWeb.Areas.Medical.Models.MedicalDashboardViewModel

@{
    ViewData["Title"] = "Mon Planning";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Modern Palette (Indigo/Blue for Doctors)
    var primaryColor = "#4F46E5";

    var todayCount = Model.AppointmentsToday.Count;
    var weekCount = Model.WeekCalendar.Values.Sum(l => l.Count);
    var nextAppointment = Model.AppointmentsToday
        .OrderBy(r => r.DateHeure)
        .FirstOrDefault();
    var upcomingWeek = Model.WeekCalendar.Values
        .SelectMany(l => l)
        .Where(r => r.DateHeure >= DateTime.Now)
        .OrderBy(r => r.DateHeure)
        .Take(4)
        .ToList();

    var congeDays = Model.WeeklyConges
        .SelectMany(c => Enumerable.Range(0, (c.DateFin.Date - c.DateDebut.Date).Days + 1)
            .Select(offset => c.DateDebut.Date.AddDays(offset)))
        .ToHashSet();
}

<style>
    :root {
        --primary: #4F46E5;
        --primary-dark: #4338ca;
        --secondary: #64748b;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1e293b;
        --light: #f8fafc;
        --surface: #ffffff;
        --border: rgba(226, 232, 240, 0.8);
    }

    body {
        background: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.06), transparent 30%),
            radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.05), transparent 30%),
            #f5f7fb;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* Animations */
    @@keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-entry {
        opacity: 0;
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .delay-100 { animation-delay: 0.1s; }
    .delay-200 { animation-delay: 0.2s; }

    /* Cards */
    .glass-card {
        background: var(--surface);
        border-radius: 20px;
        border: 1px solid var(--border);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .glass-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
    }

    /* Hero Header */
    .doctor-hero {
        background: linear-gradient(135deg, var(--primary) 0%, #818CF8 100%);
        border-radius: 20px;
        padding: 2.5rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.3);
        position: relative;
        overflow: hidden;
    }

    .doctor-hero::after {
        content: '';
        position: absolute;
        right: -10%; top: -50%;
        width: 300px; height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        pointer-events: none;
    }

    /* Stats Row */
    .stat-card {
        background: var(--surface);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 1rem;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stat-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, transparent 40%, rgba(79, 70, 229, 0.07));
        pointer-events: none;
    }

    .stat-icon {
        width: 52px; height: 52px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        font-size: 1.5rem;
        color: white;
        box-shadow: 0 8px 20px -6px rgba(79, 70, 229, 0.5);
    }
    .bg-indigo { background: linear-gradient(135deg, #6366F1, #4338CA); }
    .bg-green { background: linear-gradient(135deg, #34D399, #10B981); }
    .bg-amber { background: linear-gradient(135deg, #FBBF24, #F59E0B); }

    .progress-bar-soft {
        height: 8px;
        border-radius: 999px;
        background: #e0e7ff;
        position: relative;
        overflow: hidden;
    }

    .progress-bar-soft > span {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(90deg, #6366F1, #4338CA);
        box-shadow: 0 6px 18px -8px rgba(79, 70, 229, 0.7);
    }

    /* Action Pills */
    .action-pill {
        background: rgba(255, 255, 255, 0.22);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.55rem 1.1rem;
        border-radius: 999px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        backdrop-filter: blur(4px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .action-pill:hover { transform: translateY(-2px); box-shadow: 0 10px 18px -8px rgba(0,0,0,0.25); }

    .nav-chip {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.65rem 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        color: var(--dark);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .nav-chip:hover { border-color: var(--primary); color: var(--primary); box-shadow: 0 8px 16px -8px rgba(79,70,229,0.2); }

    /* Appointment List */
    .app-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 1rem;
        align-items: center;
        transition: background 0.2s;
        text-decoration: none;
        color: inherit;
    }
    .app-item:hover { background-color: #F8FAFC; }
    .app-item:last-child { border-bottom: none; }

    .time-badge {
        background: #EEF2FF;
        color: var(--primary);
        font-weight: 700;
        padding: 0.5rem 0.8rem;
        border-radius: 10px;
        min-width: 75px;
        text-align: center;
    }

    /* Calendar Grid */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
    }

    .day-col {
        background: var(--surface);
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
    }

    .day-header {
        padding: 0.75rem;
        text-align: center;
        border-bottom: 1px solid var(--border);
        background: #F8FAFC;
    }

    .day-col.is-today {
        border: 2px solid var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }
    .day-col.is-today .day-header {
        background: #EEF2FF;
        color: var(--primary);
        font-weight: 700;
    }

    .mini-event {
        background: #EFF6FF;
        border-left: 3px solid var(--primary);
        padding: 0.5rem;
        margin: 0.5rem;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .conge-badge {
        background: linear-gradient(120deg, #fee2e2, #fecdd3);
        color: #b91c1c;
        padding: 0.35rem 0.75rem;
        border-radius: 10px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.85rem;
    }

    .conge-pill {
        border: 1px dashed #fca5a5;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: #fff5f5;
    }

    .conge-timeline {
        position: relative;
        padding-left: 1.5rem;
    }

    .conge-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(var(--primary), transparent);
        opacity: 0.3;
    }

    .conge-node {
        position: relative;
        padding: 0.75rem 1rem;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 4px 10px -6px rgba(0,0,0,0.15);
    }

    .conge-node::before {
        content: '';
        position: absolute;
        left: -1.1rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        background: var(--primary);
        border-radius: 50%;
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.12);
    }
</style>

<div class="container-fluid py-4" style="max-width: 1400px;">

    <!-- 1. Hero Header -->
    <div class="doctor-hero animate-entry">
        <div class="d-flex flex-wrap align-items-center justify-content-between position-relative gap-3" style="z-index: 2;">
            <div>
                <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="badge bg-white text-primary fw-bold">Espace médecin</span>
                    <span class="badge bg-light text-dark">Semaine du @Model.WeekStartDate.ToString("dd MMM")</span>
                </div>
                <h1 class="fw-bold mb-2">Bonjour, Dr. @Model.DoctorProfile.Nom</h1>
                <p class="mb-0 opacity-90">Visualisez vos consultations, préparez vos dossiers et restez informé(e) d'un coup d'œil.</p>

                @if (nextAppointment != null)
                {
                    <div class="mt-3 d-inline-flex align-items-center gap-2 px-3 py-2 rounded-3 bg-white bg-opacity-15" style="backdrop-filter: blur(2px);">
                        <span class="badge bg-white text-primary fw-bold">Prochain RDV</span>
                        <div>
                            <div class="fw-bold">@nextAppointment.Patient.Nom @nextAppointment.Patient.Prenom</div>
                            <small class="opacity-75">@nextAppointment.DateHeure.ToString("HH:mm") • @nextAppointment.Motif</small>
                        </div>
                    </div>
                }
            </div>
            <div class="text-end">
                <div class="bg-white bg-opacity-25 p-3 rounded-circle d-inline-flex align-items-center justify-content-center" style="width:64px;height:64px;">
                    <i class="fas fa-user-md fa-2x"></i>
                </div>
                <div class="mt-3 d-flex flex-wrap justify-content-end gap-2">
                    <a href="@Url.Action("Create", "Consultation", new { area = "Medical" })" class="action-pill"><i class="fas fa-stethoscope"></i> Nouvelle consultation</a>
                    <a href="@Url.Action("Create", "Prescription", new { area = "Medical" })" class="action-pill"><i class="fas fa-prescription"></i> Nouvelle ordonnance</a>
                    <a href="@Url.Action("Create", "DossierMedicals", new { area = "Medical" })" class="action-pill"><i class="fas fa-folder-plus"></i> Nouveau dossier</a>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Stats Row -->
    <div class="row g-4 mb-4 animate-entry delay-100">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-icon bg-indigo"><i class="fas fa-calendar-day"></i></div>
                <div>
                    <h2 class="fw-bold mb-0 text-dark">@todayCount</h2>
                    <small class="text-muted fw-bold">Rendez-vous Aujourd'hui</small>
                    <div class="progress-bar-soft mt-2"><span style="width: @(weekCount == 0 ? 0 : Math.Min(100, Math.Round(((double)todayCount / weekCount) * 100)))%;"></span></div>
                    <small class="text-muted">@((weekCount == 0 ? 0 : Math.Round(((double)todayCount / weekCount) * 100)))% de la semaine</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-icon bg-green"><i class="fas fa-calendar-week"></i></div>
                <div>
                    <h2 class="fw-bold mb-0 text-dark">@weekCount</h2>
                    <small class="text-muted fw-bold">Total Semaine</small>
                    <div class="d-flex align-items-center gap-2 text-muted mt-1">
                        <i class="fas fa-chart-line text-success"></i>
                        <small>Planning équilibré</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
             <div class="stat-card justify-content-center bg-white">
                 <div class="text-center">
                     <p class="mb-0 text-muted small fw-bold text-uppercase">Date du jour</p>
                     <h4 class="fw-bold text-primary mb-1">@DateTime.Now.ToString("dddd dd MMMM")</h4>
                     <span class="badge bg-light text-dark">@DateTime.Now.ToString("HH:mm")</span>
                 </div>
             </div>
        </div>
    </div>

    <div class="row g-4 animate-entry delay-200">

        <!-- 3. Today's Agenda (Left) -->
        <div class="col-lg-4">
            <div class="glass-card h-100">
                <div class="p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-clock me-2 text-primary"></i>Aujourd'hui</h5>
                    <span class="badge bg-light text-dark border">@DateTime.Now.ToString("dd/MM")</span>
                </div>

                @if (Model.AppointmentsToday.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var rdv in Model.AppointmentsToday)
                        {
                            <div class="app-item">
                                <div class="time-badge">@rdv.DateHeure.ToString("HH:mm")</div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <div class="fw-bold text-dark text-truncate">@rdv.Patient.Nom @rdv.Patient.Prenom</div>
                                    <div class="small text-muted text-truncate">@rdv.Motif</div>
                                </div>
                                <a href="@Url.Action("Index", "DossierMedicals", new { area = "Medical", searchTerm = rdv.Patient.Nom })"
                                   class="btn btn-sm btn-outline-primary rounded-circle" title="Ouvrir Dossier">
                                    <i class="fas fa-folder-open"></i>
                                </a>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <div class="mb-3 text-muted opacity-25">
                            <i class="fas fa-mug-hot fa-3x"></i>
                        </div>
                        <h6 class="text-muted">Aucun rendez-vous aujourd'hui.</h6>
                    </div>
                }
            </div>
        </div>

        <!-- 4. Weekly Calendar (Right) -->
        <div class="col-lg-8">
            <div class="glass-card p-4 h-100">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
                    <div>
                        <p class="text-muted small mb-1">Vue Hebdomadaire</p>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <a class="nav-chip" href="@Url.Action("Index", new { area = "Medical", weekStart = Model.PreviousWeekStart.ToString("yyyy-MM-dd") })"><i class="fas fa-chevron-left"></i> Semaine précédente</a>
                            <h4 class="fw-bold text-dark mb-0">@Model.WeekStartDate.ToString("dd MMM") - @Model.WeekEndDate.ToString("dd MMM")</h4>
                            <a class="nav-chip" href="@Url.Action("Index", new { area = "Medical", weekStart = Model.NextWeekStart.ToString("yyyy-MM-dd") })">Semaine suivante <i class="fas fa-chevron-right"></i></a>
                        </div>
                    </div>
                    <!-- Legend -->
                    <div class="d-flex flex-wrap gap-3 small text-muted">
                        <div class="d-flex align-items-center gap-1"><div class="rounded-circle bg-primary" style="width:8px;height:8px;"></div> RDV Confirmé</div>
                        <div class="d-flex align-items-center gap-1"><div class="rounded-circle" style="width:8px;height:8px;background:#fca5a5;"></div> Congé</div>
                    </div>
                </div>

                <div class="calendar-grid mb-4">
                    @foreach (var day in Model.WeekCalendar)
                    {
                        var isToday = day.Key.Date == DateTime.Today;

                        <div class="day-col @(isToday ? "is-today" : "")">
                            <div class="day-header">
                                <div class="small text-uppercase opacity-75">@day.Key.ToString("ddd", new CultureInfo("fr-FR"))</div>
                                <div class="d-flex justify-content-center align-items-center gap-2">
                                    <div class="fs-4 fw-bold mb-0">@day.Key.Day</div>
                                    @if (congeDays.Contains(day.Key.Date))
                                    {
                                        <span class="conge-badge"><i class="fas fa-umbrella-beach"></i> Congé</span>
                                    }
                                </div>
                            </div>
                            <div class="p-2" style="min-height: 120px;">
                                @if (day.Value.Any())
                                {
                                    @foreach (var rdv in day.Value)
                                    {
                                        <div class="mini-event" title="@rdv.DateHeure.ToString("HH:mm") - @rdv.Patient.Nom">
                                            <span class="fw-bold">@rdv.DateHeure.ToString("HH:mm")</span>
                                            @rdv.Patient.Nom
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="text-center text-muted small opacity-25 mt-4">-</div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="glass-card border-0" style="background: #F8FAFF;">
                    <div class="p-3 border-bottom d-flex align-items-center gap-2">
                        <i class="fas fa-bell text-primary"></i>
                        <span class="fw-bold">Rappels rapides</span>
                    </div>
                    <div class="p-3">
                        @if (upcomingWeek.Any())
                        {
                            <div class="d-flex flex-wrap gap-3">
                                @foreach (var rdv in upcomingWeek)
                                {
                                    <div class="border rounded-4 px-3 py-2 bg-white shadow-sm" style="min-width: 220px;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="badge bg-primary bg-opacity-10 text-primary">@rdv.DateHeure.ToString("ddd", new CultureInfo("fr-FR"))</span>
                                            <span class="fw-bold text-dark">@rdv.DateHeure.ToString("HH:mm")</span>
                                        </div>
                                        <div class="fw-bold text-dark text-truncate">@rdv.Patient.Nom @rdv.Patient.Prenom</div>
                                        <small class="text-muted text-truncate d-block">@rdv.Motif</small>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">Aucun rappel pour le moment. Bonne journée !</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-1 animate-entry delay-200">
        <div class="col-lg-6">
            <div class="glass-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <p class="text-muted small mb-1">Visibilité</p>
                        <h4 class="fw-bold text-dark mb-0">Mes congés</h4>
                    </div>
                    <span class="badge bg-light text-dark">Synchronisé</span>
                </div>

                @if (Model.UpcomingConges.Any())
                {
                    <div class="conge-timeline d-flex flex-column gap-3">
                        @foreach (var conge in Model.UpcomingConges)
                        {
                            <div class="conge-node">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="fw-bold text-dark"><i class="fas fa-umbrella-beach text-primary me-2"></i>@conge.DateDebut.ToString("dd MMM", new CultureInfo("fr-FR")) - @conge.DateFin.ToString("dd MMM", new CultureInfo("fr-FR"))</div>
                                    <span class="badge bg-primary bg-opacity-10 text-primary">@((conge.DateFin - conge.DateDebut).Days + 1) j</span>
                                </div>
                                <div class="text-muted small">@(!string.IsNullOrWhiteSpace(conge.Motif) ? conge.Motif : "Congé planifié")</div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-umbrella-beach fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">Aucun congé prévu. Vous pouvez en demander un ci-dessous.</p>
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-6">
            <div class="glass-card p-4 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <p class="text-muted small mb-1">Demande</p>
                        <h4 class="fw-bold text-dark mb-0">Demander un congé</h4>
                    </div>
                    <i class="fas fa-paper-plane text-primary"></i>
                </div>

                @if (TempData["CongeSuccess"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>@TempData["CongeSuccess"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                <form asp-area="Medical" asp-controller="Dashboard" asp-action="RequestConge" method="post" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Date de début</label>
                        <input type="date" name="dateDebut" class="form-control" value="@Model.NewCongeRequest.DateDebut.ToString("yyyy-MM-dd")" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Date de fin</label>
                        <input type="date" name="dateFin" class="form-control" value="@Model.NewCongeRequest.DateFin.ToString("yyyy-MM-dd")" required />
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold">Motif (optionnel)</label>
                        <textarea name="motif" class="form-control" rows="2" placeholder="Ex: Congé annuel, formation, repos ...">@Model.NewCongeRequest.Motif</textarea>
                    </div>
                    @if (ViewData.ModelState.ContainsKey("CongeDate") && ViewData.ModelState["CongeDate"].Errors.Any())
                    {
                        <div class="col-12">
                            <div class="alert alert-danger py-2">
                                @ViewData.ModelState["CongeDate"].Errors.First().ErrorMessage
                            </div>
                        </div>
                    }
                    <div class="col-12 d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary px-4"><i class="fas fa-paper-plane me-2"></i>Envoyer à l'admin</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
