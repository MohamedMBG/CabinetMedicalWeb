@using System.Linq
@model CabinetMedicalWeb.Models.DossierMedical

@{
    ViewData["Title"] = "Créer un Dossier Médical";
    var btnPrimary = "#91B3D9";
    var bgHeader = "#A7CBED";
    var bgPage = "#E9EFF7";
    var textMain = "#666B72";
}

@{
    var initialPatients = ViewData["PatientsList"] as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
}

<div class="container-fluid py-4" style="background-color: @bgPage; min-height: 100vh;">

    <div class="card shadow-sm mx-auto" style="max-width: 860px; border: 1px solid #d9dfe6;">
        <div class="card-header text-white d-flex align-items-center" style="background-color: @bgHeader;">
            <div class="rounded-circle bg-white d-flex align-items-center justify-content-center me-3" style="width: 44px; height: 44px;">
                <i class="fas fa-folder-plus" style="color: @btnPrimary;"></i>
            </div>
            <div>
                <h4 class="mb-0" style="color: @textMain;">Créer un Nouveau Dossier</h4>
                <small class="text-muted">Associez le dossier à un patient déjà enregistré</small>
            </div>
        </div>

        <div class="card-body bg-white">
            <form asp-action="Create">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span>Le patient doit être ajouté par le secrétariat (FrontDesk) avant de pouvoir créer son dossier médical.</span>
                </div>

                <div class="row g-4">
                    <div class="col-lg-7">
                        <label asp-for="PatientId" class="form-label fw-bold" style="color: @textMain;">Sélectionner le Patient</label>

                        <div class="input-group input-group-lg mb-3 shadow-sm">
                            <span class="input-group-text bg-white"><i class="fas fa-search" style="color: @btnPrimary;"></i></span>
                            <input type="search" id="patientSearch" class="form-control" placeholder="Rechercher par nom, prénom ou téléphone" aria-label="Rechercher un patient" />
                        </div>

                        <select asp-for="PatientId" class="form-select form-select-lg shadow-sm" id="PatientId">
                            <option value="">-- Choisir un Patient --</option>
                            @foreach (var patient in initialPatients)
                            {
                                <option value="@patient.Id" data-telephone="@patient.Telephone" data-email="@patient.Email" data-birth="@patient.DateNaissance">@patient.FullName</option>
                            }
                        </select>

                        <div id="noPatientsAlert" class="alert alert-warning mt-2 small d-none">
                            ⚠️ Aucun patient trouvé. Ajoutez-en via l'espace FrontDesk ou vérifiez la connexion à la base de données.
                        </div>

                        <div id="patientsCount" class="form-text mt-1 text-muted"></div>

                        <span asp-validation-for="PatientId" class="text-danger"></span>
                    </div>

                    <div class="col-lg-5">
                        <div class="card border-0 shadow-sm h-100" style="background-color: #f7fbff;">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background-color: @btnPrimary;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0" style="color: @textMain;">Patient sélectionné</h6>
                                        <small class="text-muted">Les informations se mettront à jour automatiquement</small>
                                    </div>
                                </div>
                                <dl class="row mb-0 small" id="selectedPatientDetails">
                                    <dt class="col-5 text-muted">Nom complet</dt>
                                    <dd class="col-7" data-field="name">—</dd>
                                    <dt class="col-5 text-muted">Téléphone</dt>
                                    <dd class="col-7" data-field="phone">—</dd>
                                    <dt class="col-5 text-muted">Email</dt>
                                    <dd class="col-7" data-field="email">—</dd>
                                    <dt class="col-5 text-muted">Date de naissance</dt>
                                    <dd class="col-7" data-field="dob">—</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a asp-action="Index" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-chevron-left me-2"></i>Retour
                    </a>
                    <button type="submit" class="btn text-white fw-bold px-5" style="background-color: @btnPrimary;">
                        <i class="fas fa-save me-2"></i>Créer le Dossier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        (() => {
            const patientSelect = document.getElementById('PatientId');
            const patientSearch = document.getElementById('patientSearch');
            const noPatientsAlert = document.getElementById('noPatientsAlert');
            const patientsCount = document.getElementById('patientsCount');
            const detailsCard = document.getElementById('selectedPatientDetails');
            const endpoint = '@Url.Action("PatientsList", "DossierMedicals", new { area = "Medical" })';

            const displayDetails = () => {
                const selected = patientSelect.selectedOptions[0];
                const mappings = {
                    name: selected?.textContent?.trim() || '—',
                    phone: selected?.dataset?.telephone || '—',
                    email: selected?.dataset?.email || '—',
                    dob: selected?.dataset?.birth || '—'
                };

                detailsCard.querySelectorAll('[data-field]').forEach(el => {
                    const key = el.dataset.field;
                    el.textContent = mappings[key] || '—';
                });
            };

            const updateCountsFromSelect = () => {
                const count = Math.max(patientSelect.options.length - 1, 0);
                patientsCount.textContent = count ? `${count} patient(s) disponible(s)` : 'Aucun patient disponible';
                noPatientsAlert.classList.toggle('d-none', count > 0);
            };

            const buildOption = patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = patient.fullName || 'Patient sans nom';
                option.dataset.telephone = patient.telephone || '';
                option.dataset.email = patient.email || '';
                option.dataset.birth = patient.dateNaissance || '';
                return option;
            };

            const populatePatients = async (term = '') => {
                const previouslySelected = patientSelect.value;
                patientsCount.textContent = 'Chargement des patients...';
                try {
                    const url = term ? `${endpoint}?searchTerm=${encodeURIComponent(term)}` : endpoint;
                    const response = await fetch(url, { headers: { 'Accept': 'application/json' } });

                    if (!response.ok) {
                        throw new Error('Impossible de récupérer les patients.');
                    }

                    const patients = await response.json();
                    const fragment = document.createDocumentFragment();
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = '-- Choisir un Patient --';
                    fragment.appendChild(placeholder);

                    patients.forEach(patient => {
                        const option = buildOption(patient);
                        if (previouslySelected && previouslySelected === option.value) {
                            option.selected = true;
                        }
                        fragment.appendChild(option);
                    });

                    patientSelect.replaceChildren(fragment);
                    updateCountsFromSelect();
                    displayDetails();
                }
                catch (error) {
                    console.error(error);
                    patientsCount.textContent = 'Erreur lors du chargement des patients';
                    updateCountsFromSelect();
                }
            };

            const debounce = (fn, delay = 250) => {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), delay);
                };
            };

            patientSelect.addEventListener('change', () => {
                displayDetails();
                updateCountsFromSelect();
            });
            patientSearch.addEventListener('input', debounce(e => populatePatients(e.target.value), 250));

            updateCountsFromSelect();
            displayDetails();
            populatePatients();
        })();
    </script>
}