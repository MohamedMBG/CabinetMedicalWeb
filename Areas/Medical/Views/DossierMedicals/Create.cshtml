@using CabinetMedicalWeb.Areas.Medical.Models
@{
    ViewData["Title"] = "Create Medical Record";
    
    // Safety check for nulls
    var availablePatients = ViewBag.AvailablePatients as List<PatientListItem> ?? new List<PatientListItem>();
    var searchTerm = ViewBag.SearchTerm as string ?? string.Empty;
    var patientCount = ViewBag.PatientCount as int? ?? 0;
    
    // Styling variables
    var colorPrimary = "#91B3D9";
    var bgPage = "#E9EFF7";
    var textDark = "#666B72";
}

<style>
    body { background-color: @bgPage; font-family: 'Inter', system-ui, sans-serif; }

    .patient-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }

    .patient-card:hover {
        border-color: @colorPrimary;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(145, 179, 217, 0.2);
    }

    /* Selected State Style */
    .patient-card.selected {
        border-color: @colorPrimary;
        background-color: rgba(145, 179, 217, 0.1);
        box-shadow: 0 0 0 2px @colorPrimary; /* Stronger visual cue */
    }

    .patient-avatar {
        width: 50px; height: 50px;
        border-radius: 10px;
        background: @colorPrimary;
        color: white;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 1.2rem;
    }

    .btn-create-record {
        background: @colorPrimary;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s;
    }
    
    .btn-create-record:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .btn-create-record:not(:disabled):hover {
        background-color: #7aa3d1; /* Darker shade */
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<div class="container py-5" style="max-width: 900px;">
    
    <!-- Header -->
    <div class="mb-4">
        <h1 class="fw-bold" style="color: @textDark;">Create Medical Record</h1>
        <p class="text-muted">Select a patient below to proceed.</p>
    </div>

    <!-- Alert Messages -->
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mb-4">@TempData["ErrorMessage"]</div>
    }

    <!-- Search Form -->
    <div class="card border-0 shadow-sm mb-4 p-3 rounded-4">
        <form method="get" asp-action="Create" class="d-flex gap-2">
            <input type="text" name="searchTerm" value="@searchTerm" class="form-control border-0 bg-light py-2" placeholder="Search patient..." style="border-radius: 10px;">
            <button type="submit" class="btn btn-primary px-4" style="background-color: @colorPrimary; border: none; border-radius: 10px;">Search</button>
            @if(!string.IsNullOrEmpty(searchTerm)) {
                <a href="@Url.Action("Create")" class="btn btn-light" style="border-radius: 10px;">Clear</a>
            }
        </form>
    </div>

    <!-- Main Selection Form -->
    <form method="post" asp-action="Create" id="createForm">
        @Html.AntiForgeryToken()

        @if (availablePatients.Count == 0)
        {
            <div class="text-center py-5 text-muted">
                <i class="fas fa-users-slash fa-3x mb-3"></i>
                <h4>No patients found</h4>
                <p>Try searching for a different name or add a new patient.</p>
            </div>
        }
        else
        {
            <div id="patientListContainer">
                @foreach (var patient in availablePatients)
                {
                    <!-- NOTICE: No onclick="" here. We handle it in script below. -->
                    <div class="patient-card" id="card_@patient.Id">
                        <div class="d-flex align-items-center">
                            
                            <!-- Radio Button (Hidden but functional) -->
                            <div class="me-3">
                                <input type="radio" name="patientId" value="@patient.Id" 
                                       id="radio_@patient.Id" 
                                       class="form-check-input" 
                                       style="width: 1.5em; height: 1.5em; cursor: pointer;">
                            </div>

                            <!-- Avatar -->
                            <div class="patient-avatar me-3">
                                @(patient.FullName.Length > 0 ? patient.FullName.Substring(0, 1) : "P")
                            </div>

                            <!-- Info -->
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold">@patient.FullName</h6>
                                <small class="text-muted">
                                    <i class="fas fa-phone me-1"></i> @patient.Telephone 
                                    <span class="mx-2">•</span> 
                                    @patient.DateNaissance
                                </small>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="mt-4 pt-3 border-top d-flex gap-2">
                <a href="@Url.Action("Index")" class="btn btn-light flex-grow-0" style="min-width: 120px;">Cancel</a>
                
                <!-- ID is strictly 'submitBtn' -->
                <button type="submit" id="submitBtn" class="btn-create-record flex-grow-1" disabled>
                    Select a Patient to Continue
                </button>
            </div>
        }
    </form>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const submitBtn = document.getElementById('submitBtn');
        const cards = document.querySelectorAll('.patient-card');

        // Function to handle selection visual state
        function handleSelection(radioInput) {
            // 1. Remove 'selected' class from ALL cards
            cards.forEach(c => c.classList.remove('selected'));

            // 2. Find the card belonging to the checked radio
            const selectedCard = document.querySelector(`#card_${radioInput.value}`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // 3. Enable the button
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create Medical Record';
            }
        }

        // Add click listener to every card
        cards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Find the radio inside this card
                const radio = this.querySelector('input[type="radio"]');

                // If the user clicked the radio itself, don't double-trigger
                if (e.target === radio) return;

                // Otherwise, check the radio manually
                radio.checked = true;

                // Manually trigger the selection logic
                handleSelection(radio);
            });
        });

        // Listen for native radio changes (handles keyboard nav or direct clicks)
        const radios = document.querySelectorAll('input[name="patientId"]');
        radios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    handleSelection(this);
                }
            });
        });
    });
</script>
